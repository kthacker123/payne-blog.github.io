<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="SO逆向入门实战教程八：文件读写"><meta name="keywords" content=""><meta name="author" content="PayNeXss"><meta name="copyright" content="PayNeXss"><title>SO逆向入门实战教程八：文件读写 | PayNeXss</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E7%AB%A0%E7%9B%AE%E5%BD%95"><span class="toc-number">1.</span> <span class="toc-text">文章目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E5%89%8D%E8%A8%80"><span class="toc-number">2.</span> <span class="toc-text">一、前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E3%80%81demo1%E8%AE%BE%E8%AE%A1"><span class="toc-number">3.</span> <span class="toc-text">二、demo1设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%89%E3%80%81Unidbg%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8Cdemo1"><span class="toc-number">4.</span> <span class="toc-text">三、Unidbg模拟执行demo1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E3%80%81demo2%E8%AE%BE%E8%AE%A1"><span class="toc-number">5.</span> <span class="toc-text">四、demo2设计</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94%E3%80%81Unidbg%E6%A8%A1%E6%8B%9F%E6%89%A7%E8%A1%8Cdemo2"><span class="toc-number">6.</span> <span class="toc-text">五、Unidbg模拟执行demo2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%AD%E3%80%81%E5%B0%BE%E5%A3%B0"><span class="toc-number">7.</span> <span class="toc-text">六、尾声</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars2.githubusercontent.com/u/5448638?s=460&amp;v=4"></div><div class="author-info__name text-center">PayNeXss</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">11</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">1</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s3.bmp.ovh/imgs/2021/09/a7ee5c8e87cffb0f.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">PayNeXss</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div><div id="post-info"><div id="post-title">SO逆向入门实战教程八：文件读写</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-06-18</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/SO%E9%80%86%E5%90%91%E5%AE%9E%E6%88%98%E5%8D%81%E4%B8%89%E7%AF%87/">SO逆向实战十三篇</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><span id="more"></span>

<h3 id="文章目录"><a href="#文章目录" class="headerlink" title="文章目录"></a>文章目录</h3><ul>
<li><ul>
<li><ul>
<li><a href="#_2">一、前言</a></li>
<li><a href="#demo1_10">二、demo1设计</a></li>
<li><a href="#Unidbgdemo1_223">三、Unidbg模拟执行demo1</a></li>
<li><a href="#demo2_507">四、demo2设计</a></li>
<li><a href="#Unidbgdemo2_892">五、Unidbg模拟执行demo2</a></li>
<li><a href="#_1094">六、尾声</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h3><p>本篇分析的是自写demo，帮助大家熟悉Unidbg中对文件读写的处理，例子中主要涉及</p>
<ul>
<li>Sharedpreference 读写</li>
<li>Assets 读写</li>
<li>文件 读写</li>
</ul>
<h3 id="二、demo1设计"><a href="#二、demo1设计" class="headerlink" title="二、demo1设计"></a>二、demo1设计</h3><blockquote>
<p>Sharedpreferences是Android平台上常用的存储方式，用来保存应用程序的各种配置信息，其本质是一个以“键-值”对的方式保存数据的xml文件，其文件保存在/data/data/selfPackage/shared_prefs目录下。</p>
</blockquote>
<p>在APP刚启动时，我们新建两个Sharedpreference 文件，分别填入两个键值对，name-lilac和location-china，代码实现</p>
<p>（如果对开发不感兴趣，也可以直接去百度网盘中获取demo文件的apk进行分析）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.roysue.readsp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.SharedPreferences;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Used to load the &#x27;native-lib&#x27; library on application startup.</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native-lib&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//步骤1：创建SharedPreferences对象</span></span><br><span class="line">        SharedPreferences sharedPreferences1= getSharedPreferences(<span class="string">&quot;one&quot;</span>, Context.MODE_PRIVATE);</span><br><span class="line">        SharedPreferences sharedPreferences2= getSharedPreferences(<span class="string">&quot;two&quot;</span>, Context.MODE_PRIVATE);</span><br><span class="line">        <span class="comment">//步骤2： 实例化SharedPreferences.Editor对象</span></span><br><span class="line">        SharedPreferences.Editor editor1 = sharedPreferences1.edit();</span><br><span class="line">        SharedPreferences.Editor editor2 = sharedPreferences2.edit();</span><br><span class="line">        <span class="comment">//步骤3：将获取过来的值放入文件</span></span><br><span class="line">        editor1.putString(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;lilac&quot;</span>);</span><br><span class="line">        editor2.putString(<span class="string">&quot;location&quot;</span>, <span class="string">&quot;china&quot;</span>);</span><br><span class="line">        <span class="comment">//步骤4：提交</span></span><br><span class="line">        editor1.apply();</span><br><span class="line">        editor2.apply();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        TextView tv = findViewById(R.id.sample_text);</span><br><span class="line">        Button btn = findViewById(R.id.button);</span><br><span class="line">        btn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">                tv.setText(stringFromJNI(getApplicationContext()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * A native method that is implemented by the &#x27;native-lib&#x27; native library,</span></span><br><span class="line"><span class="comment">     * which is packaged with this application.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">stringFromJNI</span><span class="params">(Context context)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在shared_prefs下反映为两个如下的xml</p>
<p>one.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27; standalone=&#x27;yes&#x27; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>&gt;</span>lilac<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>two.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27; standalone=&#x27;yes&#x27; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;location&quot;</span>&gt;</span>china<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在程序逻辑中，我们打算在stringFromJni中做一件很简单的事：在1.xml中读取gt_m的值，在2.xml中读取gt_fp的值，然后拼接后打印。</p>
<p>但在代码实现上，我们打算绕个弯</p>
<p>在读取1.xml的name上，我们使用JNI去调用JAVA层对SharedPreference操纵的API。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//反射Context类</span></span><br><span class="line">jclass cls_Context = env-&gt;FindClass(<span class="string">&quot;android/content/Context&quot;</span>);</span><br><span class="line"><span class="comment">//反射Context类getSharedPreferences方法</span></span><br><span class="line">jmethodID mid_getSharedPreferences = env-&gt;GetMethodID(cls_Context,</span><br><span class="line">                                                      <span class="string">&quot;getSharedPreferences&quot;</span>,</span><br><span class="line">                                                      <span class="string">&quot;(Ljava/lang/String;I)Landroid/content/SharedPreferences;&quot;</span>);</span><br><span class="line"><span class="comment">//获取Context类MODE_PRIVATE属性值</span></span><br><span class="line"><span class="comment">//执行反射方法</span></span><br><span class="line">jobject obj_sharedPreferences = env-&gt;CallObjectMethod(mycontext,</span><br><span class="line">                                                      mid_getSharedPreferences, env-&gt;NewStringUTF(<span class="string">&quot;one&quot;</span>),</span><br><span class="line">                                                      <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">jclass cls_SharedPreferences = env-&gt;FindClass(<span class="string">&quot;android/content/SharedPreferences&quot;</span>);</span><br><span class="line"><span class="comment">//反射SharedPreferences类的getString方法</span></span><br><span class="line">jmethodID mid_getString = env-&gt;GetMethodID(cls_SharedPreferences,</span><br><span class="line">                                           <span class="string">&quot;getString&quot;</span>,</span><br><span class="line">                                           <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>);</span><br><span class="line"><span class="comment">//参数类型转换</span></span><br><span class="line">jstring key_name = env-&gt;NewStringUTF(<span class="string">&quot;name&quot;</span>);</span><br><span class="line"><span class="comment">//参数类型转换</span></span><br><span class="line">jstring default_value = env-&gt;NewStringUTF(<span class="string">&quot; &quot;</span>);</span><br><span class="line"><span class="comment">//执行反射方法</span></span><br><span class="line">jstring key_value1 = (jstring) env-&gt;CallObjectMethod(obj_sharedPreferences,</span><br><span class="line">                                                              mid_getString, key_name, default_value);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *c_key_value1 =  env-&gt;GetStringUTFChars(key_value1, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>在读取2.xml的location上，我们换个方式，既然Sharedpreference本质上是个xml文件，那么用native中原生的open函数去读可能会更隐蔽，可是open本质上也是通过底层系统调用open的方式实现，那我们直截了当通过系统调用open打开这个xml也是一样。（处理时，我懒得切割字符串，所以直接拼接two.xml整个xml吧。）</p>
<p>完整代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;jni.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">#include &lt;sys/syscall.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line"></span><br><span class="line">__attribute__((naked))</span><br><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">raw_syscall</span><span class="params">(<span class="keyword">long</span> _number,...)</span></span>&#123;</span><br><span class="line">    <span class="function">__asm__ <span class="title">__volatile__</span> <span class="params">(<span class="string">&quot;MOV R12,SP\r\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="string">&quot;STMFD SP!,&#123;R4-R7&#125;\r\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="string">&quot;MOV R7,R0\r\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="string">&quot;MOV R0,R1\r\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="string">&quot;MOV R1,R2\r\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="string">&quot;MOV R2,R3\r\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="string">&quot;LDMIA R12,&#123;R3-R6&#125;\r\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="string">&quot;SVC 0\r\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="string">&quot;LDMFD SP!,&#123;R4-R7&#125;\r\n&quot;</span></span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="string">&quot;mov pc,lr&quot;</span>)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>* test_syscall(<span class="keyword">const</span> <span class="keyword">char</span>* file_path)&#123;</span><br><span class="line">    <span class="keyword">char</span> *result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">long</span> fd = raw_syscall(<span class="number">5</span>,file_path, O_RDONLY | O_CREAT, <span class="number">400</span>);</span><br><span class="line">    <span class="keyword">if</span>(fd != -<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">char</span> buffer[<span class="number">0x100</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">        raw_syscall(<span class="number">3</span>, fd, buffer, <span class="number">0x100</span>);</span><br><span class="line">        result = buffer;</span><br><span class="line">        raw_syscall(<span class="number">6</span>, fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">extern <span class="string">&quot;C&quot;</span> <span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_roysue_readsp_MainActivity_stringFromJNI</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        JNIEnv* env,</span></span></span><br><span class="line"><span class="params"><span class="function">        jobject <span class="comment">/* this */</span>, jobject mycontext)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//反射Context类</span></span><br><span class="line">    jclass cls_Context = env-&gt;FindClass(<span class="string">&quot;android/content/Context&quot;</span>);</span><br><span class="line">    <span class="comment">//反射Context类getSharedPreferences方法</span></span><br><span class="line">    jmethodID mid_getSharedPreferences = env-&gt;GetMethodID(cls_Context,</span><br><span class="line">                                                          <span class="string">&quot;getSharedPreferences&quot;</span>,</span><br><span class="line">                                                          <span class="string">&quot;(Ljava/lang/String;I)Landroid/content/SharedPreferences;&quot;</span>);</span><br><span class="line">    <span class="comment">//获取Context类MODE_PRIVATE属性值</span></span><br><span class="line">    <span class="comment">//执行反射方法</span></span><br><span class="line">    jobject obj_sharedPreferences = env-&gt;CallObjectMethod(mycontext,</span><br><span class="line">                                                          mid_getSharedPreferences, env-&gt;NewStringUTF(<span class="string">&quot;one&quot;</span>),</span><br><span class="line">                                                          <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    jclass cls_SharedPreferences = env-&gt;FindClass(<span class="string">&quot;android/content/SharedPreferences&quot;</span>);</span><br><span class="line">    <span class="comment">//反射SharedPreferences类的getString方法</span></span><br><span class="line">    jmethodID mid_getString = env-&gt;GetMethodID(cls_SharedPreferences,</span><br><span class="line">                                               <span class="string">&quot;getString&quot;</span>,</span><br><span class="line">                                               <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>);</span><br><span class="line">    <span class="comment">//参数类型转换</span></span><br><span class="line">    jstring key_name = env-&gt;NewStringUTF(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    <span class="comment">//参数类型转换</span></span><br><span class="line">    jstring default_value = env-&gt;NewStringUTF(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    <span class="comment">//执行反射方法</span></span><br><span class="line">    jstring key_value1 = (jstring) env-&gt;CallObjectMethod(obj_sharedPreferences,</span><br><span class="line">                                                                  mid_getString, key_name, default_value);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *c_key_value1 =  env-&gt;GetStringUTFChars(key_value1, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *path = <span class="string">&quot;/data/data/com.roysue.readsp/shared_prefs/two.xml&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *result = test_syscall(path);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> dest[<span class="number">1000</span>];</span><br><span class="line"></span><br><span class="line">    strcpy(dest,c_key_value1);</span><br><span class="line">    strcat(dest,result);</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(dest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果即</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lilac<span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27; standalone=&#x27;yes&#x27; ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;location&quot;</span>&gt;</span>china<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>需要注意的是，因为只是一个demo，所以有些地方采用了硬编码，自己跑代码的时候，如果无法顺利跑出结果，请检查是否是路径等硬编码与本机环境不符，或者在微信联系我，很荣幸和同侪交流互动。</p>
<h3 id="三、Unidbg模拟执行demo1"><a href="#三、Unidbg模拟执行demo1" class="headerlink" title="三、Unidbg模拟执行demo1"></a>三、Unidbg模拟执行demo1</h3><p>首先想一下我们可能遇到的问题，应该就是两个</p>
<ul>
<li>补JAVA环境（one.xml的读取是通过JNI调用JAVA层API实现的）</li>
<li>补文件访问/重定向 (two.xml的读取，最终通过open系统调用实现，需要将文件重定向到本机某个位置</li>
</ul>
<p>快开干</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lession8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.AbstractJni;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo1</span> <span class="keyword">extends</span> <span class="title">AbstractJni</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line"></span><br><span class="line">    demo1()&#123;</span><br><span class="line">        <span class="comment">// 防止进程名检测</span></span><br><span class="line">        emulator = AndroidEmulatorBuilder.for32Bit().setProcessName(<span class="string">&quot;com.readSp&quot;</span>).build(); <span class="comment">// 创建模拟器实例，要模拟32位或者64位，在这里区分</span></span><br><span class="line">        <span class="keyword">final</span> Memory memory = emulator.getMemory(); <span class="comment">// 模拟器的内存操作接口</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> AndroidResolver(<span class="number">23</span>)); <span class="comment">// 设置系统类库解析</span></span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        DalvikModule dm = vm.loadLibrary(<span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\pr0214\\Desktop\\DTA\\unidbg\\versions\\unidbg-2021-5-17\\unidbg-master\\unidbg-android\\src\\test\\java\\com\\lession8\\libnative-lib.so&quot;</span>), <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">module</span> = dm.getModule();</span><br><span class="line">        </span><br><span class="line">        vm.setJni(<span class="keyword">this</span>);</span><br><span class="line">        vm.setVerbose(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Object&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        list.add(vm.getJNIEnv()); <span class="comment">// 第一个参数是env</span></span><br><span class="line">        list.add(<span class="number">0</span>); <span class="comment">// 第二个参数，实例方法是jobject，静态方法是jclazz，直接填0，一般用不到。</span></span><br><span class="line">        Object custom = <span class="keyword">null</span>;</span><br><span class="line">        DvmObject&lt;?&gt; context = vm.resolveClass(<span class="string">&quot;android/content/Context&quot;</span>).newObject(custom);<span class="comment">// context</span></span><br><span class="line">        list.add(vm.addLocalObject(context));</span><br><span class="line">        Number number = <span class="keyword">module</span>.callFunction(emulator, <span class="number">0xAAC</span> + <span class="number">1</span>, list.toArray())[<span class="number">0</span>];</span><br><span class="line">        String result = vm.getObject(number.intValue()).getValue().toString();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        demo1 test = <span class="keyword">new</span> demo1();</span><br><span class="line">        System.out.println(test.call());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行</p>
<p><img src="https://img-blog.csdnimg.cn/20210618132454781.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>JAVA环境缺失，在获取getSharedPreferences，对应于开发中的这一步</p>
<p><img src="https://img-blog.csdnimg.cn/20210618132510134.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>方法参数1是Sharedpreference的名字，参数2默认为0即可，返回SharedPreferences对象。</p>
<p>我们补一个空的SharedPreferences返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;android/content/Context-&gt;getSharedPreferences(Ljava/lang/String;I)Landroid/content/SharedPreferences;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;android/content/SharedPreferences&quot;</span>).newObject(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但我们需要思考一下，这样真的好吗？</p>
<p>假设APP在JNI中从五个SharedPreferences里读了十五个键值对，并且不同xml的键名有重复，如果每次取SharedPreferences时我们都返回空对象，那后面怎么区分a.xml和b.xml里键名都是name的数据呢？</p>
<p>先前我们说，参数1是想要获取的SharedPreferences的名字，应该把它放对象里返回，这样就有了”标识性“</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;android/content/Context-&gt;getSharedPreferences(Ljava/lang/String;I)Landroid/content/SharedPreferences;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;android/content/SharedPreferences&quot;</span>).newObject(vaList.getObject(<span class="number">0</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续运行</p>
<p><img src="https://img-blog.csdnimg.cn/20210618132525627.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>显然，这儿就是在获取one.xml的name所对应的值，我们应该返回lilac</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;android/content/Context-&gt;getSharedPreferences(Ljava/lang/String;I)Landroid/content/SharedPreferences;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;android/content/SharedPreferences&quot;</span>).newObject(vaList.getObject(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;android/content/SharedPreferences-&gt;getString(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> StringObject(vm, <span class="string">&quot;lilac&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样做固然可以，但能不能更严谨规范一些呢？当然可以</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;android/content/Context-&gt;getSharedPreferences(Ljava/lang/String;I)Landroid/content/SharedPreferences;&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;android/content/SharedPreferences&quot;</span>).newObject(vaList.getObject(<span class="number">0</span>));</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;android/content/SharedPreferences-&gt;getString(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>: &#123;</span><br><span class="line">            <span class="comment">// 如果是one.xml</span></span><br><span class="line">            <span class="keyword">if</span>(((StringObject) dvmObject.getValue()).getValue().equals(<span class="string">&quot;one&quot;</span>))&#123;</span><br><span class="line">                <span class="comment">// 如果键是name</span></span><br><span class="line">                <span class="keyword">if</span> (vaList.getObject(<span class="number">0</span>).getValue().equals(<span class="string">&quot;name&quot;</span>)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> StringObject(vm, <span class="string">&quot;lilac&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着运行</p>
<p><img src="https://img-blog.csdnimg.cn/20210618132535497.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>显然，对one.xml的读取已经顺利完成了，可是千万别忘了，two.xml呢？</p>
<p>为什么没有做拼接？或者说，为什么Unidbg没有提醒我们对文件进行重定向？two.xml 我们还没操作呢！</p>
<p>这是因为我们对two.xml的操作采用系统调用的方式完成，但我们没有打开Unidbg中系统调用的日志显示。</p>
<p>如下打开对arm32中系统调用的日志显示</p>
<p><img src="https://img-blog.csdnimg.cn/20210618132544212.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>再次运行<br><img src="https://img-blog.csdnimg.cn/20210618132557819.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>事实上，我建议运行真实样本时，开启所有的日志以防错过重要的环境缺失。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.ARM32SyscallHandler&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.unix.UnixSyscallHandler&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.AbstractEmulator&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.android.dvm.DalvikVM&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.android.dvm.BaseVM&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.android.dvm&quot;</span>).setLevel(Level.DEBUG);</span><br></pre></td></tr></table></figure>

<p>上篇中，我们讲了两种方式补文件访问</p>
<p>1是Unidbg提供的rootfs虚拟文件系统，2是代码方式文件重定向 大家自行选择，有人可能会问，如果我不想传入文件，能不能只传入”字符串“，当然可以，从SimpleFileIO换成ByteArrayFileIO即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FileResult <span class="title">resolve</span><span class="params">(Emulator emulator, String pathname, <span class="keyword">int</span> oflags)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;/data/data/com.roysue.readsp/shared_prefs/two.xml&quot;</span>.equals(pathname)) &#123;</span><br><span class="line">        <span class="keyword">return</span> FileResult.success(<span class="keyword">new</span> ByteArrayFileIO(oflags, pathname, <span class="string">&quot;mytest&quot;</span>.getBytes()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看一下完整代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lession8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Emulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.file.FileResult;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.file.IOResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.AbstractJni;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.file.ByteArrayFileIO;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Level;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo1</span> <span class="keyword">extends</span> <span class="title">AbstractJni</span> <span class="keyword">implements</span> <span class="title">IOResolver</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line"></span><br><span class="line">    demo1()&#123;</span><br><span class="line">        <span class="comment">// 防止进程名检测</span></span><br><span class="line">        emulator = AndroidEmulatorBuilder.for32Bit().setProcessName(<span class="string">&quot;com.readSp&quot;</span>).build(); <span class="comment">// 创建模拟器实例，要模拟32位或者64位，在这里区分</span></span><br><span class="line">        <span class="keyword">final</span> Memory memory = emulator.getMemory(); <span class="comment">// 模拟器的内存操作接口</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> AndroidResolver(<span class="number">23</span>)); <span class="comment">// 设置系统类库解析</span></span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        emulator.getSyscallHandler().addIOResolver(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        DalvikModule dm = vm.loadLibrary(<span class="keyword">new</span> File(<span class="string">&quot;unidbg-android\\src\\test\\java\\com\\lession8\\libnative-lib.so&quot;</span>), <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">module</span> = dm.getModule();</span><br><span class="line"></span><br><span class="line">        vm.setJni(<span class="keyword">this</span>);</span><br><span class="line">        vm.setVerbose(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Object&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        list.add(vm.getJNIEnv()); <span class="comment">// 第一个参数是env</span></span><br><span class="line">        list.add(<span class="number">0</span>); <span class="comment">// 第二个参数，实例方法是jobject，静态方法是jclazz，直接填0，一般用不到。</span></span><br><span class="line">        Object custom = <span class="keyword">null</span>;</span><br><span class="line">        DvmObject&lt;?&gt; context = vm.resolveClass(<span class="string">&quot;android/content/Context&quot;</span>).newObject(custom);<span class="comment">// context</span></span><br><span class="line">        list.add(vm.addLocalObject(context));</span><br><span class="line">        Number number = <span class="keyword">module</span>.callFunction(emulator, <span class="number">0xAAC</span> + <span class="number">1</span>, list.toArray())[<span class="number">0</span>];</span><br><span class="line">        String result = vm.getObject(number.intValue()).getValue().toString();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> DvmObject&lt;?&gt; callObjectMethodV(BaseVM vm, DvmObject&lt;?&gt; dvmObject, String signature, VaList vaList) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (signature) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;android/content/Context-&gt;getSharedPreferences(Ljava/lang/String;I)Landroid/content/SharedPreferences;&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> vm.resolveClass(<span class="string">&quot;android/content/SharedPreferences&quot;</span>).newObject(vaList.getObject(<span class="number">0</span>));</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;android/content/SharedPreferences-&gt;getString(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;&quot;</span>: &#123;</span><br><span class="line">                <span class="comment">// 如果是one.xml</span></span><br><span class="line">                <span class="keyword">if</span>(((StringObject) dvmObject.getValue()).getValue().equals(<span class="string">&quot;one&quot;</span>))&#123;</span><br><span class="line">                    <span class="comment">// 如果键是name</span></span><br><span class="line">                    <span class="keyword">if</span> (vaList.getObject(<span class="number">0</span>).getValue().equals(<span class="string">&quot;name&quot;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> StringObject(vm, <span class="string">&quot;lilac&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.callObjectMethodV(vm, dvmObject, signature, vaList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.ARM32SyscallHandler&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">        demo1 test = <span class="keyword">new</span> demo1();</span><br><span class="line">        System.out.println(test.call());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FileResult <span class="title">resolve</span><span class="params">(Emulator emulator, String pathname, <span class="keyword">int</span> oflags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;/data/data/com.roysue.readsp/shared_prefs/two.xml&quot;</span>.equals(pathname)) &#123;</span><br><span class="line">            <span class="keyword">return</span> FileResult.success(<span class="keyword">new</span> ByteArrayFileIO(oflags, pathname, <span class="string">&quot;mytest&quot;</span>.getBytes()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20210618132625361.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="四、demo2设计"><a href="#四、demo2设计" class="headerlink" title="四、demo2设计"></a>四、demo2设计</h3><p>各类加密算法大部分都有密钥的存在，非对称加密算法还有公钥私钥之分，所以加密算法运算时需要传入密钥，但是直接参数方式传递很容易被分析者意识到这是密钥，有没有办法更隐蔽一些呢？</p>
<p>比如我们把密钥放在xml中，在native中读取它，就类似于demo1</p>
<p>有没有更隐蔽一些些的呢，我们可以把密钥藏在资源文件的图片里，即在so里读取资源文件里的某张图片，以它的某部分或者整体的md5结果作为密钥？这是一个更好的方案。</p>
<p>demo2就是这个方案的简单实现——native中读取资源文件的1.jpg，并求其md5值，返回JAVA层。</p>
<p>看一下代码</p>
<p>JAVA层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.roysue.readasset;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.res.AssetManager;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Used to load the &#x27;native-lib&#x27; library on application startup.</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;native-lib&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Example of a call to a native method</span></span><br><span class="line">        TextView tv = findViewById(R.id.sample_text);</span><br><span class="line">        tv.setText(setNativeAssetManager(getAssets()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">setNativeAssetManager</span><span class="params">(AssetManager assetManager)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Native层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;jni.h&gt;</span><br><span class="line">#include &lt;string&gt;</span><br><span class="line">#include <span class="string">&quot;android/asset_manager.h&quot;</span></span><br><span class="line">#include <span class="string">&quot;android/asset_manager_jni.h&quot;</span></span><br><span class="line"></span><br><span class="line">#define MD5_LONG unsigned <span class="keyword">long</span></span><br><span class="line"><span class="comment">// 分组大小</span></span><br><span class="line">#define MD5_CBLOCK	<span class="number">64</span></span><br><span class="line"><span class="comment">// 分块个数</span></span><br><span class="line">#<span class="function">define <span class="title">MD5_LBLOCK</span>	<span class="params">(MD5_CBLOCK/<span class="number">4</span>)</span></span></span><br><span class="line"><span class="function"><span class="comment">// 摘要长度（字节）</span></span></span><br><span class="line"><span class="function">#define MD5_DIGEST_LENGTH 16</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#define MD32_REG_T <span class="keyword">long</span></span></span><br><span class="line"><span class="function"><span class="comment">// 小端序</span></span></span><br><span class="line"><span class="function">#define DATA_ORDER_IS_LITTLE_ENDIAN</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 四个初始化常量</span></span></span><br><span class="line"><span class="function">#define <span class="title">INIT_DATA_A</span> <span class="params">(unsigned <span class="keyword">long</span>)</span>0x67452301L</span></span><br><span class="line"><span class="function">#define <span class="title">INIT_DATA_B</span> <span class="params">(unsigned <span class="keyword">long</span>)</span>0xefcdab89L</span></span><br><span class="line"><span class="function">#define <span class="title">INIT_DATA_C</span> <span class="params">(unsigned <span class="keyword">long</span>)</span>0x98badcfeL</span></span><br><span class="line"><span class="function">#define <span class="title">INIT_DATA_D</span> <span class="params">(unsigned <span class="keyword">long</span>)</span>0x10325476L</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 循环左移以及取低64位</span></span></span><br><span class="line"><span class="function">#define <span class="title">ROTATE</span><span class="params">(a,n)</span>     <span class="params">(((a)</span>&lt;&lt;<span class="params">(n)</span>)|<span class="params">(((a)</span>&amp;0xffffffff)&gt;&gt;<span class="params">(<span class="number">32</span>-(n)</span>)))</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// 大小端序互转</span></span></span><br><span class="line"><span class="function">#define <span class="title">HOST_c2l</span><span class="params">(c,l)</span>	<span class="params">(l =(((unsigned <span class="keyword">long</span>)</span><span class="params">(*((c)</span>++)))    ),		\</span></span><br><span class="line"><span class="function">			 l|</span>=(((unsigned <span class="keyword">long</span>)(*((c)++)))&lt;&lt; <span class="number">8</span>),		\</span><br><span class="line">			 l|=(((unsigned <span class="keyword">long</span>)(*((c)++)))&lt;&lt;<span class="number">16</span>),		\</span><br><span class="line">			 l|=(((unsigned <span class="keyword">long</span>)(*((c)++)))&lt;&lt;<span class="number">24</span>)		)</span><br><span class="line"></span><br><span class="line">#<span class="function">define <span class="title">HOST_l2c</span><span class="params">(l,c)</span>	<span class="params">(*((c)</span>++)</span>=(unsigned <span class="keyword">char</span>)(((l)    )&amp;<span class="number">0xff</span>),	\</span><br><span class="line">			 *((c)++)=(unsigned <span class="keyword">char</span>)(((l)&gt;&gt; <span class="number">8</span>)&amp;<span class="number">0xff</span>),	\</span><br><span class="line">			 *((c)++)=(unsigned <span class="keyword">char</span>)(((l)&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>),	\</span><br><span class="line">			 *((c)++)=(unsigned <span class="keyword">char</span>)(((l)&gt;&gt;<span class="number">24</span>)&amp;<span class="number">0xff</span>),	\</span><br><span class="line">			 l)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新链接变量值</span></span><br><span class="line">#<span class="function">define	<span class="title">HASH_MAKE_STRING</span><span class="params">(c,s)</span>	<span class="keyword">do</span> </span>&#123;	\</span><br><span class="line">	unsigned <span class="keyword">long</span> ll;		\</span><br><span class="line">	ll=(c)-&gt;A; (<span class="keyword">void</span>)HOST_l2c(ll,(s));	\</span><br><span class="line">	ll=(c)-&gt;B; (<span class="keyword">void</span>)HOST_l2c(ll,(s));	\</span><br><span class="line">	ll=(c)-&gt;C; (<span class="keyword">void</span>)HOST_l2c(ll,(s));	\</span><br><span class="line">	ll=(c)-&gt;D; (<span class="keyword">void</span>)HOST_l2c(ll,(s));	\</span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 四个初始化非线性函数，或者叫逻辑函数</span></span><br><span class="line">#<span class="function">define	<span class="title">F</span><span class="params">(b,c,d)</span>	<span class="params">((((c)</span> ^ <span class="params">(d)</span>) &amp; <span class="params">(b)</span>) ^ <span class="params">(d)</span>)</span></span><br><span class="line"><span class="function">#define	<span class="title">G</span><span class="params">(b,c,d)</span>	<span class="params">((((b)</span> ^ <span class="params">(c)</span>) &amp; <span class="params">(d)</span>) ^ <span class="params">(c)</span>)</span></span><br><span class="line"><span class="function">#define	<span class="title">H</span><span class="params">(b,c,d)</span>	<span class="params">((b)</span> ^ <span class="params">(c)</span> ^ <span class="params">(d)</span>)</span></span><br><span class="line"><span class="function">#define	<span class="title">I</span><span class="params">(b,c,d)</span>	<span class="params">(((~(d)</span>) | <span class="params">(b)</span>) ^ <span class="params">(c)</span>)</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// F函数，每隔16步/轮 换下一个</span></span></span><br><span class="line"><span class="function">#define <span class="title">R0</span><span class="params">(a,b,c,d,k,s,t)</span> </span>&#123; \</span><br><span class="line">	a+=((k)+(t)+F((b),(c),(d))); \</span><br><span class="line">	a=ROTATE(a,s); \</span><br><span class="line">	a+=b; &#125;;</span><br><span class="line"></span><br><span class="line">#<span class="function">define <span class="title">R1</span><span class="params">(a,b,c,d,k,s,t)</span> </span>&#123; \</span><br><span class="line">	a+=((k)+(t)+G((b),(c),(d))); \</span><br><span class="line">	a=ROTATE(a,s); \</span><br><span class="line">	a+=b;&#125;;</span><br><span class="line"></span><br><span class="line">#<span class="function">define <span class="title">R2</span><span class="params">(a,b,c,d,k,s,t)</span> </span>&#123; \</span><br><span class="line">	a+=((k)+(t)+H((b),(c),(d))); \</span><br><span class="line">	a=ROTATE(a,s); \</span><br><span class="line">	a+=b; &#125;;</span><br><span class="line"></span><br><span class="line">#<span class="function">define <span class="title">R3</span><span class="params">(a,b,c,d,k,s,t)</span> </span>&#123; \</span><br><span class="line">	a+=((k)+(t)+I((b),(c),(d))); \</span><br><span class="line">	a=ROTATE(a,s); \</span><br><span class="line">	a+=b; &#125;;</span><br><span class="line"></span><br><span class="line">typedef struct MD5state_st1&#123;</span><br><span class="line">    MD5_LONG A,B,C,D; <span class="comment">// ABCD</span></span><br><span class="line">    MD5_LONG Nl,Nh; <span class="comment">// 数据的bit数计数器(对2^64取余)，Nh存储高32位，Nl存储低32位。这种设计是服务于32位处理器，MD5的设计就是为了服务于32位处理器的。</span></span><br><span class="line">    MD5_LONG data[MD5_LBLOCK];<span class="comment">//数据缓冲区</span></span><br><span class="line">    unsigned <span class="keyword">int</span> num;</span><br><span class="line">&#125;MD5_CTX; <span class="comment">// 存放MD5算法相关信息的结构体定义</span></span><br><span class="line"></span><br><span class="line">unsigned <span class="keyword">char</span> cleanse_ctr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化链接变量/幻数</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Init</span><span class="params">(MD5_CTX *c)</span></span>&#123;</span><br><span class="line">    memset (c,<span class="number">0</span>,sizeof(*c));</span><br><span class="line">    c-&gt;A=INIT_DATA_A;</span><br><span class="line">    c-&gt;B=INIT_DATA_B;</span><br><span class="line">    c-&gt;C=INIT_DATA_C;</span><br><span class="line">    c-&gt;D=INIT_DATA_D;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// md5 一个分组中的全部运算</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">md5_block_data_order</span><span class="params">(MD5_CTX *c, <span class="keyword">const</span> <span class="keyword">void</span> *data_, unsigned <span class="keyword">int</span> num)</span></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> unsigned <span class="keyword">char</span> *data= static_cast&lt;<span class="keyword">const</span> unsigned <span class="keyword">char</span> *&gt;(data_);</span><br><span class="line">    register unsigned MD32_REG_T A,B,C,D,l;</span><br><span class="line">#ifndef MD32_XARRAY</span><br><span class="line">    unsigned MD32_REG_T	XX0, XX1, XX2, XX3, XX4, XX5, XX6, XX7,</span><br><span class="line">            XX8, XX9,XX10,XX11,XX12,XX13,XX14,XX15;</span><br><span class="line"># <span class="function">define <span class="title">X</span><span class="params">(i)</span>	XX##i</span></span><br><span class="line"><span class="function">#<span class="keyword">else</span></span></span><br><span class="line"><span class="function">    MD5_LONG XX[MD5_LBLOCK]</span>;</span><br><span class="line"># <span class="function">define <span class="title">X</span><span class="params">(i)</span>	XX[i]</span></span><br><span class="line"><span class="function">#endif</span></span><br><span class="line"><span class="function">    A</span>=c-&gt;A;</span><br><span class="line">    B=c-&gt;B;</span><br><span class="line">    C=c-&gt;C;</span><br><span class="line">    D=c-&gt;D;</span><br><span class="line">    <span class="comment">// 64轮</span></span><br><span class="line">    <span class="comment">// 前16轮需要改变分组中每个分块的</span></span><br><span class="line">    <span class="keyword">for</span> (;num--;)&#123;</span><br><span class="line">        HOST_c2l(data,l); X( <span class="number">0</span>)=l;		HOST_c2l(data,l); X( <span class="number">1</span>)=l;</span><br><span class="line">        <span class="comment">/* Round 0 */</span></span><br><span class="line">        R0(A,B,C,D,X( <span class="number">0</span>), <span class="number">7</span>,<span class="number">0xd76aa478L</span>);	HOST_c2l(data,l); X( <span class="number">2</span>)=l;</span><br><span class="line">        R0(D,A,B,C,X( <span class="number">1</span>),<span class="number">12</span>,<span class="number">0xe8c7b756L</span>);	HOST_c2l(data,l); X( <span class="number">3</span>)=l;</span><br><span class="line">        R0(C,D,A,B,X( <span class="number">2</span>),<span class="number">17</span>,<span class="number">0x242070dbL</span>);	HOST_c2l(data,l); X( <span class="number">4</span>)=l;</span><br><span class="line">        R0(B,C,D,A,X( <span class="number">3</span>),<span class="number">22</span>,<span class="number">0xc1bdceeeL</span>);	HOST_c2l(data,l); X( <span class="number">5</span>)=l;</span><br><span class="line">        R0(A,B,C,D,X( <span class="number">4</span>), <span class="number">7</span>,<span class="number">0xf57c0fafL</span>);	HOST_c2l(data,l); X( <span class="number">6</span>)=l;</span><br><span class="line">        R0(D,A,B,C,X( <span class="number">5</span>),<span class="number">12</span>,<span class="number">0x4787c62aL</span>);	HOST_c2l(data,l); X( <span class="number">7</span>)=l;</span><br><span class="line">        R0(C,D,A,B,X( <span class="number">6</span>),<span class="number">17</span>,<span class="number">0xa8304613L</span>);	HOST_c2l(data,l); X( <span class="number">8</span>)=l;</span><br><span class="line">        R0(B,C,D,A,X( <span class="number">7</span>),<span class="number">22</span>,<span class="number">0xfd469501L</span>);	HOST_c2l(data,l); X( <span class="number">9</span>)=l;</span><br><span class="line">        R0(A,B,C,D,X( <span class="number">8</span>), <span class="number">7</span>,<span class="number">0x698098d8L</span>);	HOST_c2l(data,l); X(<span class="number">10</span>)=l;</span><br><span class="line">        R0(D,A,B,C,X( <span class="number">9</span>),<span class="number">12</span>,<span class="number">0x8b44f7afL</span>);	HOST_c2l(data,l); X(<span class="number">11</span>)=l;</span><br><span class="line">        R0(C,D,A,B,X(<span class="number">10</span>),<span class="number">17</span>,<span class="number">0xffff5bb1L</span>);	HOST_c2l(data,l); X(<span class="number">12</span>)=l;</span><br><span class="line">        R0(B,C,D,A,X(<span class="number">11</span>),<span class="number">22</span>,<span class="number">0x895cd7beL</span>);	HOST_c2l(data,l); X(<span class="number">13</span>)=l;</span><br><span class="line">        R0(A,B,C,D,X(<span class="number">12</span>), <span class="number">7</span>,<span class="number">0x6b901122L</span>);	HOST_c2l(data,l); X(<span class="number">14</span>)=l;</span><br><span class="line">        R0(D,A,B,C,X(<span class="number">13</span>),<span class="number">12</span>,<span class="number">0xfd987193L</span>);	HOST_c2l(data,l); X(<span class="number">15</span>)=l;</span><br><span class="line">        R0(C,D,A,B,X(<span class="number">14</span>),<span class="number">17</span>,<span class="number">0xa679438eL</span>);</span><br><span class="line">        R0(B,C,D,A,X(<span class="number">15</span>),<span class="number">22</span>,<span class="number">0x49b40821L</span>);</span><br><span class="line">        <span class="comment">/* Round 1 */</span></span><br><span class="line">        R1(A,B,C,D,X( <span class="number">1</span>), <span class="number">5</span>,<span class="number">0xf61e2562L</span>);</span><br><span class="line">        R1(D,A,B,C,X( <span class="number">6</span>), <span class="number">9</span>,<span class="number">0xc040b340L</span>);</span><br><span class="line">        R1(C,D,A,B,X(<span class="number">11</span>),<span class="number">14</span>,<span class="number">0x265e5a51L</span>);</span><br><span class="line">        R1(B,C,D,A,X( <span class="number">0</span>),<span class="number">20</span>,<span class="number">0xe9b6c7aaL</span>);</span><br><span class="line">        R1(A,B,C,D,X( <span class="number">5</span>), <span class="number">5</span>,<span class="number">0xd62f105dL</span>);</span><br><span class="line">        R1(D,A,B,C,X(<span class="number">10</span>), <span class="number">9</span>,<span class="number">0x02441453L</span>);</span><br><span class="line">        R1(C,D,A,B,X(<span class="number">15</span>),<span class="number">14</span>,<span class="number">0xd8a1e681L</span>);</span><br><span class="line">        R1(B,C,D,A,X( <span class="number">4</span>),<span class="number">20</span>,<span class="number">0xe7d3fbc8L</span>);</span><br><span class="line">        R1(A,B,C,D,X( <span class="number">9</span>), <span class="number">5</span>,<span class="number">0x21e1cde6L</span>);</span><br><span class="line">        R1(D,A,B,C,X(<span class="number">14</span>), <span class="number">9</span>,<span class="number">0xc33707d6L</span>);</span><br><span class="line">        R1(C,D,A,B,X( <span class="number">3</span>),<span class="number">14</span>,<span class="number">0xf4d50d87L</span>);</span><br><span class="line">        R1(B,C,D,A,X( <span class="number">8</span>),<span class="number">20</span>,<span class="number">0x455a14edL</span>);</span><br><span class="line">        R1(A,B,C,D,X(<span class="number">13</span>), <span class="number">5</span>,<span class="number">0xa9e3e905L</span>);</span><br><span class="line">        R1(D,A,B,C,X( <span class="number">2</span>), <span class="number">9</span>,<span class="number">0xfcefa3f8L</span>);</span><br><span class="line">        R1(C,D,A,B,X( <span class="number">7</span>),<span class="number">14</span>,<span class="number">0x676f02d9L</span>);</span><br><span class="line">        R1(B,C,D,A,X(<span class="number">12</span>),<span class="number">20</span>,<span class="number">0x8d2a4c8aL</span>);</span><br><span class="line">        <span class="comment">/* Round 2 */</span></span><br><span class="line">        R2(A,B,C,D,X( <span class="number">5</span>), <span class="number">4</span>,<span class="number">0xfffa3942L</span>);</span><br><span class="line">        R2(D,A,B,C,X( <span class="number">8</span>),<span class="number">11</span>,<span class="number">0x8771f681L</span>);</span><br><span class="line">        R2(C,D,A,B,X(<span class="number">11</span>),<span class="number">16</span>,<span class="number">0x6d9d6122L</span>);</span><br><span class="line">        R2(B,C,D,A,X(<span class="number">14</span>),<span class="number">23</span>,<span class="number">0xfde5380cL</span>);</span><br><span class="line">        R2(A,B,C,D,X( <span class="number">1</span>), <span class="number">4</span>,<span class="number">0xa4beea44L</span>);</span><br><span class="line">        R2(D,A,B,C,X( <span class="number">4</span>),<span class="number">11</span>,<span class="number">0x4bdecfa9L</span>);</span><br><span class="line">        R2(C,D,A,B,X( <span class="number">7</span>),<span class="number">16</span>,<span class="number">0xf6bb4b60L</span>);</span><br><span class="line">        R2(B,C,D,A,X(<span class="number">10</span>),<span class="number">23</span>,<span class="number">0xbebfbc70L</span>);</span><br><span class="line">        R2(A,B,C,D,X(<span class="number">13</span>), <span class="number">4</span>,<span class="number">0x289b7ec6L</span>);</span><br><span class="line">        R2(D,A,B,C,X( <span class="number">0</span>),<span class="number">11</span>,<span class="number">0xeaa127faL</span>);</span><br><span class="line">        R2(C,D,A,B,X( <span class="number">3</span>),<span class="number">16</span>,<span class="number">0xd4ef3085L</span>);</span><br><span class="line">        R2(B,C,D,A,X( <span class="number">6</span>),<span class="number">23</span>,<span class="number">0x04881d05L</span>);</span><br><span class="line">        R2(A,B,C,D,X( <span class="number">9</span>), <span class="number">4</span>,<span class="number">0xd9d4d039L</span>);</span><br><span class="line">        R2(D,A,B,C,X(<span class="number">12</span>),<span class="number">11</span>,<span class="number">0xe6db99e5L</span>);</span><br><span class="line">        R2(C,D,A,B,X(<span class="number">15</span>),<span class="number">16</span>,<span class="number">0x1fa27cf8L</span>);</span><br><span class="line">        R2(B,C,D,A,X( <span class="number">2</span>),<span class="number">23</span>,<span class="number">0xc4ac5665L</span>);</span><br><span class="line">        <span class="comment">/* Round 3 */</span></span><br><span class="line">        R3(A,B,C,D,X( <span class="number">0</span>), <span class="number">6</span>,<span class="number">0xf4292244L</span>);</span><br><span class="line">        R3(D,A,B,C,X( <span class="number">7</span>),<span class="number">10</span>,<span class="number">0x432aff97L</span>);</span><br><span class="line">        R3(C,D,A,B,X(<span class="number">14</span>),<span class="number">15</span>,<span class="number">0xab9423a7L</span>);</span><br><span class="line">        R3(B,C,D,A,X( <span class="number">5</span>),<span class="number">21</span>,<span class="number">0xfc93a039L</span>);</span><br><span class="line">        R3(A,B,C,D,X(<span class="number">12</span>), <span class="number">6</span>,<span class="number">0x655b59c3L</span>);</span><br><span class="line">        R3(D,A,B,C,X( <span class="number">3</span>),<span class="number">10</span>,<span class="number">0x8f0ccc92L</span>);</span><br><span class="line">        R3(C,D,A,B,X(<span class="number">10</span>),<span class="number">15</span>,<span class="number">0xffeff47dL</span>);</span><br><span class="line">        R3(B,C,D,A,X( <span class="number">1</span>),<span class="number">21</span>,<span class="number">0x85845dd1L</span>);</span><br><span class="line">        R3(A,B,C,D,X( <span class="number">8</span>), <span class="number">6</span>,<span class="number">0x6fa87e4fL</span>);</span><br><span class="line">        R3(D,A,B,C,X(<span class="number">15</span>),<span class="number">10</span>,<span class="number">0xfe2ce6e0L</span>);</span><br><span class="line">        R3(C,D,A,B,X( <span class="number">6</span>),<span class="number">15</span>,<span class="number">0xa3014314L</span>);</span><br><span class="line">        R3(B,C,D,A,X(<span class="number">13</span>),<span class="number">21</span>,<span class="number">0x4e0811a1L</span>);</span><br><span class="line">        R3(A,B,C,D,X( <span class="number">4</span>), <span class="number">6</span>,<span class="number">0xf7537e82L</span>);</span><br><span class="line">        R3(D,A,B,C,X(<span class="number">11</span>),<span class="number">10</span>,<span class="number">0xbd3af235L</span>);</span><br><span class="line">        R3(C,D,A,B,X( <span class="number">2</span>),<span class="number">15</span>,<span class="number">0x2ad7d2bbL</span>);</span><br><span class="line">        R3(B,C,D,A,X( <span class="number">9</span>),<span class="number">21</span>,<span class="number">0xeb86d391L</span>);</span><br><span class="line"></span><br><span class="line">        A = c-&gt;A += A;</span><br><span class="line">        B = c-&gt;B += B;</span><br><span class="line">        C = c-&gt;C += C;</span><br><span class="line">        D = c-&gt;D += D;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 传入需要哈希的明文,支持多次调用</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Update</span><span class="params">(MD5_CTX *c, <span class="keyword">const</span> <span class="keyword">void</span> *data_, size_t len)</span></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> unsigned <span class="keyword">char</span> *data= static_cast&lt;<span class="keyword">const</span> unsigned <span class="keyword">char</span> *&gt;(data_);</span><br><span class="line">    unsigned <span class="keyword">char</span> *p;</span><br><span class="line">    MD5_LONG l;</span><br><span class="line">    size_t n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len==<span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// 低位</span></span><br><span class="line">    l=(c-&gt;Nl+(((MD5_LONG)len)&lt;&lt;<span class="number">3</span>))&amp;0xffffffffUL;</span><br><span class="line">    <span class="keyword">if</span> (l &lt; c-&gt;Nl)</span><br><span class="line">        c-&gt;Nh++;</span><br><span class="line">    <span class="comment">// 高位</span></span><br><span class="line">    c-&gt;Nh+=(MD5_LONG)(len&gt;&gt;<span class="number">29</span>);</span><br><span class="line">    c-&gt;Nl=l;</span><br><span class="line"></span><br><span class="line">    n = c-&gt;num;</span><br><span class="line">    <span class="keyword">if</span> (n != <span class="number">0</span>)&#123;</span><br><span class="line">        p=(unsigned <span class="keyword">char</span> *)c-&gt;data;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (len &gt;= MD5_CBLOCK || len+n &gt;= MD5_CBLOCK)&#123;</span><br><span class="line">            memcpy (p+n,data,MD5_CBLOCK-n);</span><br><span class="line">            md5_block_data_order(c,p,<span class="number">1</span>);</span><br><span class="line">            n      = MD5_CBLOCK-n;</span><br><span class="line">            data  += n;</span><br><span class="line">            len   -= n;</span><br><span class="line">            c-&gt;num = <span class="number">0</span>;</span><br><span class="line">            memset (p,<span class="number">0</span>,MD5_CBLOCK);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            memcpy (p+n,data,len);</span><br><span class="line">            c-&gt;num += (unsigned <span class="keyword">int</span>)len;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    n = len/MD5_CBLOCK;</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        md5_block_data_order(c,data,n);</span><br><span class="line">        n    *= MD5_CBLOCK;</span><br><span class="line">        data += n;</span><br><span class="line">        len  -= n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len != <span class="number">0</span>)&#123;</span><br><span class="line">        p = (unsigned <span class="keyword">char</span> *)c-&gt;data;</span><br><span class="line">        c-&gt;num = (unsigned <span class="keyword">int</span>)len;</span><br><span class="line">        memcpy (p,data,len);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 得出最终结果</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">MD5_Final</span><span class="params">(unsigned <span class="keyword">char</span> *md, MD5_CTX *c)</span></span>&#123;</span><br><span class="line">    unsigned <span class="keyword">char</span> *p = (unsigned <span class="keyword">char</span> *)c-&gt;data;</span><br><span class="line">    size_t n = c-&gt;num;</span><br><span class="line"></span><br><span class="line">    p[n] = <span class="number">0x80</span>; <span class="comment">/* there is always room for one */</span></span><br><span class="line">    n++;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n &gt; (MD5_CBLOCK-<span class="number">8</span>))&#123;</span><br><span class="line">        memset (p+n,<span class="number">0</span>,MD5_CBLOCK-n);</span><br><span class="line">        n=<span class="number">0</span>;</span><br><span class="line">        md5_block_data_order(c,p,<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    memset (p+n,<span class="number">0</span>,MD5_CBLOCK-<span class="number">8</span>-n);</span><br><span class="line"></span><br><span class="line">    p += MD5_CBLOCK-<span class="number">8</span>;</span><br><span class="line">#<span class="function"><span class="keyword">if</span>   <span class="title">defined</span><span class="params">(DATA_ORDER_IS_BIG_ENDIAN)</span></span></span><br><span class="line"><span class="function">    <span class="params">(<span class="keyword">void</span>)</span><span class="title">HOST_l2c</span><span class="params">(c-&gt;Nh,p)</span></span>;</span><br><span class="line">	(<span class="keyword">void</span>)HOST_l2c(c-&gt;Nl,p);</span><br><span class="line">#<span class="function">elif <span class="title">defined</span><span class="params">(DATA_ORDER_IS_LITTLE_ENDIAN)</span></span></span><br><span class="line"><span class="function">    <span class="params">(<span class="keyword">void</span>)</span><span class="title">HOST_l2c</span><span class="params">(c-&gt;Nl,p)</span></span>;</span><br><span class="line">    (<span class="keyword">void</span>)HOST_l2c(c-&gt;Nh,p);</span><br><span class="line">#endif</span><br><span class="line">    p -= MD5_CBLOCK;</span><br><span class="line">    md5_block_data_order(c,p,<span class="number">1</span>);</span><br><span class="line">    c-&gt;num=<span class="number">0</span>;</span><br><span class="line">    memset (p,<span class="number">0</span>,MD5_CBLOCK);</span><br><span class="line"></span><br><span class="line">#ifndef HASH_MAKE_STRING</span><br><span class="line">#error <span class="string">&quot;HASH_MAKE_STRING must be defined!&quot;</span></span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">    HASH_MAKE_STRING(c,md);</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//清除加载的各种算法，包括对称算法、摘要算法以及 PBE 算法，并清除这些算法相关的哈希表的内容。</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">OPENSSL_cleanse</span><span class="params">(<span class="keyword">void</span> *ptr, size_t len)</span></span>&#123;</span><br><span class="line">    unsigned <span class="keyword">char</span> *p = static_cast&lt;unsigned <span class="keyword">char</span> *&gt;(ptr);</span><br><span class="line">    size_t loop = len, ctr = cleanse_ctr;</span><br><span class="line">    <span class="keyword">while</span>(loop--)&#123;</span><br><span class="line">        *(p++) = (unsigned <span class="keyword">char</span>)ctr;</span><br><span class="line">        ctr += (<span class="number">17</span> + ((size_t)p &amp; <span class="number">0xF</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    p= static_cast&lt;unsigned <span class="keyword">char</span> *&gt;(memchr(ptr, (unsigned <span class="keyword">char</span>) ctr, len));</span><br><span class="line">    <span class="keyword">if</span>(p)</span><br><span class="line">        ctr += (<span class="number">63</span> + (size_t)p);</span><br><span class="line">    cleanse_ctr = (unsigned <span class="keyword">char</span>)ctr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算图片的md5值并返回</span></span><br><span class="line">extern <span class="string">&quot;C&quot;</span></span><br><span class="line"><span class="function">JNIEXPORT jstring JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_com_roysue_readasset_MainActivity_setNativeAssetManager</span><span class="params">(JNIEnv *env, jobject thiz,jobject asset_manager)</span> </span>&#123;</span><br><span class="line">    AAssetManager *nativeasset = AAssetManager_fromJava(env, asset_manager);</span><br><span class="line">    </span><br><span class="line">    AAsset *assetFile = AAssetManager_open(nativeasset, <span class="string">&quot;1.png&quot;</span>, AASSET_MODE_BUFFER);</span><br><span class="line">    size_t fileLength = AAsset_getLength(assetFile);</span><br><span class="line">    <span class="keyword">char</span> *dataBuffer = (<span class="keyword">char</span> *) malloc(fileLength);</span><br><span class="line">    <span class="comment">//read file data</span></span><br><span class="line">    AAsset_read(assetFile, dataBuffer, fileLength);</span><br><span class="line">    <span class="comment">//the data has been copied to dataBuffer2, so , close it</span></span><br><span class="line">    AAsset_close(assetFile);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化MD5的上下文结构体</span></span><br><span class="line">    MD5_CTX context = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    MD5_Init(&amp;context);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 传入待处理的内容以及内容的长度</span></span><br><span class="line">    MD5_Update(&amp;context, dataBuffer, fileLength);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 收尾和输出</span></span><br><span class="line">    <span class="comment">// 输出的缓冲区</span></span><br><span class="line">    unsigned <span class="keyword">char</span> dest[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    MD5_Final(dest, &amp;context);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 结果转成十六进制字符串</span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> szMd5[<span class="number">33</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">16</span>; i++)&#123;</span><br><span class="line">        sprintf(szMd5, <span class="string">&quot;%s%02x&quot;</span>, szMd5, dest[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//free malloc</span></span><br><span class="line">    free(dataBuffer);</span><br><span class="line">    <span class="comment">// 传回Java世界</span></span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(szMd5);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<p><img src="https://img-blog.csdnimg.cn/20210618132838300.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3 id="五、Unidbg模拟执行demo2"><a href="#五、Unidbg模拟执行demo2" class="headerlink" title="五、Unidbg模拟执行demo2"></a>五、Unidbg模拟执行demo2</h3><p>模拟执行demo2会出现什么问题呢？<br>先看一下IDA F5 效果<br><img src="https://img-blog.csdnimg.cn/20210618132924964.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>再写一下Unidbg代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.lession8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.AndroidEmulator;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.Module;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidEmulatorBuilder;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.AndroidResolver;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.linux.android.dvm.*;</span><br><span class="line"><span class="keyword">import</span> com.github.unidbg.memory.Memory;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Level;</span><br><span class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">demo2</span> <span class="keyword">extends</span> <span class="title">AbstractJni</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AndroidEmulator emulator;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> VM vm;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Module <span class="keyword">module</span>;</span><br><span class="line"></span><br><span class="line">    demo2()&#123;</span><br><span class="line">        emulator = AndroidEmulatorBuilder.for32Bit().setProcessName(<span class="string">&quot;com.readAssets&quot;</span>).build(); <span class="comment">// 创建模拟器实例，要模拟32位或者64位，在这里区分</span></span><br><span class="line">        <span class="keyword">final</span> Memory memory = emulator.getMemory(); <span class="comment">// 模拟器的内存操作接口</span></span><br><span class="line">        memory.setLibraryResolver(<span class="keyword">new</span> AndroidResolver(<span class="number">23</span>)); <span class="comment">// 设置系统类库解析</span></span><br><span class="line">        vm = emulator.createDalvikVM(<span class="keyword">new</span> File(<span class="string">&quot;unidbg-android\\src\\test\\java\\com\\lession8\\demo2.apk&quot;</span>));</span><br><span class="line"></span><br><span class="line">        DalvikModule dm = vm.loadLibrary(<span class="keyword">new</span> File(<span class="string">&quot;unidbg-android\\src\\test\\java\\com\\lession8\\libnative-lib.so&quot;</span>), <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">module</span> = dm.getModule();</span><br><span class="line"></span><br><span class="line">        vm.setJni(<span class="keyword">this</span>);</span><br><span class="line">        vm.setVerbose(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">call</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;Object&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">10</span>);</span><br><span class="line">        list.add(vm.getJNIEnv()); <span class="comment">// 第一个参数是env</span></span><br><span class="line">        list.add(<span class="number">0</span>); <span class="comment">// 第二个参数，实例方法是jobject，静态方法是jclazz，直接填0，一般用不到。</span></span><br><span class="line">        Object custom = <span class="keyword">null</span>;</span><br><span class="line">        DvmObject&lt;?&gt; assetManager = vm.resolveClass(<span class="string">&quot;android/content/res/AssetManager&quot;</span>).newObject(custom);<span class="comment">// context</span></span><br><span class="line">        list.add(vm.addLocalObject(assetManager));</span><br><span class="line"></span><br><span class="line">        Number number = <span class="keyword">module</span>.callFunction(emulator, <span class="number">0x207C</span> + <span class="number">1</span>, list.toArray())[<span class="number">0</span>];</span><br><span class="line">        String result = vm.getObject(number.intValue()).getValue().toString();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.ARM32SyscallHandler&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">        Logger.getLogger(<span class="string">&quot;com.github.unidbg.unix.UnixSyscallHandler&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">        Logger.getLogger(<span class="string">&quot;com.github.unidbg.AbstractEmulator&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">        Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.android.dvm.DalvikVM&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">        Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.android.dvm.BaseVM&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">        Logger.getLogger(<span class="string">&quot;com.github.unidbg.linux.android.dvm&quot;</span>).setLevel(Level.DEBUG);</span><br><span class="line">        demo2 test = <span class="keyword">new</span> demo2();</span><br><span class="line">        System.out.println(<span class="string">&quot;call demo2&quot;</span>);</span><br><span class="line">        System.out.println(test.call());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行</p>
<p><img src="https://img-blog.csdnimg.cn/20210618132952419.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>直截了当的报错，根据traceCode定位<br><img src="https://img-blog.csdnimg.cn/20210618133004387.png" alt="在这里插入图片描述"><br>AAssetManager_fromJava函数哪来的？为什么报错？这需要我们思考两个问题</p>
<p>1.Android开发中，Native层如何读取Assets文件<br>2.Unidbg如何处理这情况</p>
<p>首先，apk资源文件的读取与demo1不同，并非简单的open了事。<br><img src="https://img-blog.csdnimg.cn/20210618133030487.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/20210618133039120.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>Assets加载相关的API，比如AAssetManager_fromJava，就是由libandroid.so这个系统SO实现，但是呢，Unidbg并没有内置加载这个系统SO，我们首先看一下Unidbg完整支持的系统SO</p>
<p><img src="https://img-blog.csdnimg.cn/20210618133057694.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>可以发现，其实并不是很多。</p>
<p>考虑两个个问题</p>
<ol>
<li> 为什么Unidbg不内置支持所有系统SO的加载</li>
<li> 如果一个SO的依赖SO里包含Unidbg尚未支持的系统SO，那该怎么办？</li>
</ol>
<p>先讨论第一个问题</p>
<p>一部分原因是大部分SO中主要的依赖项，就是Unidbg已经支持的这些，即已经够用了。把Android系统中全部SO都成功加载进Unidbg虚拟内存中，既是很大的工作量，又会占用过多内存。</p>
<p>另一个更主要的原因是，比如libandroid.so，其依赖SO实在太多了，想顺利加载整个SO确确实实是个苦差事！</p>
<p><img src="https://img-blog.csdnimg.cn/20210618133116258.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>再看问题2</p>
<p>如果SO的依赖项中有Unidbg不支持的系统SO，怎么办？</p>
<p>首先，Unidbg会给予提示</p>
<p><img src="https://img-blog.csdnimg.cn/2021061813313088.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>其次，尽管SO加载了Unidbg不支持的SO，但有可能我们的目标函数并没有使用到这个系统SO，这种情况下就不用理会，当作不存在就行。</p>
<p>但如果目标函数使用到了这个系统SO，那就麻烦了，我们就得直面这个问题，一般有两种处理办法</p>
<ul>
<li>Patch/Hook 这个不支持的SO所使用的函数</li>
<li>使用Unidbg VirtualModule</li>
</ul>
<p>方法一没什么技术含量而且并不总是能用，我们主要看一下方法二。</p>
<p>VirtualModule是Unidbg为此种情况所提供的官方解决方案，并在代码中提供了两个示例</p>
<p><img src="https://img-blog.csdnimg.cn/20210618133148902.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述">分别是对libandroid.so以及libJniGraphics的处理<br>我们使用一下<br><img src="https://img-blog.csdnimg.cn/20210618133211197.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzM4ODUxNTM2,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>只用这一句即可，需要注意，一定要在样本SO加载前加载它，道理也很简单，系统SO肯定比用户SO加载早鸭。</p>
<p>Unidbg如何实现一个VirtualModule？此类问题我们在更后面的文章去讨论它。需要注意的是，VirtualModule并不是一种真正意义上的加载SO，它本质上也是Hook，只不过实现了SO中少数几个函数罢了。</p>
<p>比如AndroidModule中，只实现了libandroid中这几个常用的导出函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onInitialize</span><span class="params">(Emulator&lt;?&gt; emulator, <span class="keyword">final</span> VM vm, Map&lt;String, UnidbgPointer&gt; symbols)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> is64Bit = emulator.is64Bit();</span><br><span class="line">    SvcMemory svcMemory = emulator.getSvcMemory();</span><br><span class="line">    symbols.put(<span class="string">&quot;AAssetManager_fromJava&quot;</span>, svcMemory.registerSvc(is64Bit ? <span class="keyword">new</span> Arm64Svc() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> fromJava(emulator, vm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; : <span class="keyword">new</span> ArmSvc() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> fromJava(emulator, vm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">    symbols.put(<span class="string">&quot;AAssetManager_open&quot;</span>, svcMemory.registerSvc(is64Bit ? <span class="keyword">new</span> Arm64Svc() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> open(emulator, vm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; : <span class="keyword">new</span> ArmSvc() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> open(emulator, vm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">    symbols.put(<span class="string">&quot;AAsset_close&quot;</span>, svcMemory.registerSvc(is64Bit ? <span class="keyword">new</span> Arm64Svc() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> close(emulator, vm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; : <span class="keyword">new</span> ArmSvc() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> close(emulator, vm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">    symbols.put(<span class="string">&quot;AAsset_getBuffer&quot;</span>, svcMemory.registerSvc(is64Bit ? <span class="keyword">new</span> Arm64Svc() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> getBuffer(emulator, vm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; : <span class="keyword">new</span> ArmSvc() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> getBuffer(emulator, vm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">    symbols.put(<span class="string">&quot;AAsset_getLength&quot;</span>, svcMemory.registerSvc(is64Bit ? <span class="keyword">new</span> Arm64Svc() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> getLength(emulator, vm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; : <span class="keyword">new</span> ArmSvc() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> getLength(emulator, vm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">    symbols.put(<span class="string">&quot;AAsset_read&quot;</span>, svcMemory.registerSvc(is64Bit ? <span class="keyword">new</span> Arm64Svc() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BackendException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; : <span class="keyword">new</span> ArmSvc() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">handle</span><span class="params">(Emulator&lt;?&gt; emulator)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> read(emulator, vm);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="六、尾声"><a href="#六、尾声" class="headerlink" title="六、尾声"></a>六、尾声</h3><p>链接：<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/14MNPM3Rayb2RYgDS/_T5pnw">https://pan.baidu.com/s/14MNPM3Rayb2RYgDS\_T5pnw</a><br>提取码：4974</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">PayNeXss</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://paynexss.github.io/2021/06/18/(转)SO逆向入门实战教程八：文件读写/">https://paynexss.github.io/2021/06/18/(转)SO逆向入门实战教程八：文件读写/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://paynexss.github.io">PayNeXss</a>！</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/06/22/(%E8%BD%AC)SO%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98%E6%95%99%E7%A8%8B%E4%B9%9D%E2%80%94%E2%80%94blackbox/"><i class="fa fa-chevron-left">  </i><span>SO逆向入门实战教程九——blackbox</span></a></div><div class="next-post pull-right"><a href="/2021/06/17/(%E8%BD%AC)SO%E9%80%86%E5%90%91%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98%E6%95%99%E7%A8%8B%E4%B8%83%EF%BC%9Amain/"><span>SO逆向入门实战教程七：main</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s3.bmp.ovh/imgs/2021/09/a7ee5c8e87cffb0f.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By PayNeXss</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>